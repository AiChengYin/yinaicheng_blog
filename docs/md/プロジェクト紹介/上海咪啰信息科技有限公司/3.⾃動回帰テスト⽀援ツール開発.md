# ⾃動回帰テスト⽀援ツール開発

## 一、プロジェクト背景と目的

大規模な分散システムの継続的なイテレーションにおいて、コード変更、アーキテクチャ再構築、または段階的リリース後には、ビジネスロジック、データ整合性、インターフェース互換性が損なわれていないことを確認するために、大量の回帰テストを実施する必要がある。

しかし、従来の手動回帰テストには以下のような明確な課題がある：

- オフライン環境では実際の複雑なユーザシナリオを再現しにくい；
- テストケースのカバレッジが限定的；
- 保守コストが高く、検証サイクルが長い；
- 新旧システム間のインターフェース差異により、重複テストが多発。

これらの問題を解決するために、**トラフィックリプレイに基づく自動化回帰テストツール** を設計・実装した。  
本ツールは本番環境でリアルトラフィックを自動録画し、テスト環境で並列リプレイおよび結果比較を行うことで、エンドツーエンドの自動回帰検証を実現する。

<img src="https://35.212.207.101:34823/down/wIeKreku3m2Q.png" alt="" width="600"/>

### 🎯 目的：
- 実トラフィックを手動テストケースの代替として使用；
- 新旧バージョンのインターフェースを自動リプレイおよび比較；
- 可視化レポートと整合性分析結果を提供；
- 「録画 → リプレイ → 比較」プロセスをツール化・設定可能化。

<img src="https://35.212.207.101:34823/down/XUM8aAOEnPXv.png" alt="" width="600"/>

---

## 二、私の役割と担当範囲

本プロジェクトでは、**フルスタックエンジニア / アーキテクト** として、ツールチェーン全体のコアモジュール実装とフレームワーク設計を担当した。主な責務は以下の通り：

- 🔹 アーキテクチャ設計と技術選定：「トラフィック収集 → 録画 → リプレイ → 比較」全体フローをゼロから設計；
- 🔹 トラフィック録画モジュール：制御可能な録画フィルタを開発；
- 🔹 トラフィックリプレイモジュール：並列リプレイと権限構築機構を設計；
- 🔹 結果比較エンジン：自動レスポンスおよびデータベース比較ロジックを開発；
- 🔹 テストレポートとプロセス統合：XLSレポート出力と可視化統計を実現；
- 🔹 パフォーマンス最適化と自動デプロイ：実データ環境での高可用性と拡張性を確保。

---

## 三、技術スタックとアーキテクチャ

### ⚙️ 技術スタック

| モジュール | 技術選定 |
|-------------|-----------|
| トラフィック収集 | Java Servlet Filter、YAML 設定センター |
| トラフィック録画 | OkHttp + JSON シリアライズ + MySQL ストレージ |
| トラフィックリプレイ | 並列制御 + Ticket 構築 + Session シミュレーション |
| 結果比較 | HikariCP + Oracle + マルチスレッドページ比較 |
| レポート出力 | Apache POI (XLS) + 統計指標 |
| デプロイ運用 | Spring Boot + Nginx + Shell + Docker |

### 🧩 システムアーキテクチャ（論理フロー）

```
本番環境
   ↓
RequestRecordFilter → トラフィック保存テーブル
   ↓
ApplyReplayFilter → 並列で新旧環境を呼び出し
   ↓
Response 比較モジュール + DB 整合性検証
   ↓
XLS レポート出力 + アラート/監視
```

---

## 四、実装と成果

### 1️⃣ トラフィック録画モジュール

- メインシステムのエントリに RequestRecordFilter を登録し、録画有効状態を判定；
- YAML 設定に基づき URI ホワイトリストを動的ロード；
- 永続化内容：リクエストヘッダ、URI、Body、ユーザーSession、タイムスタンプなど；
- 録画完了後、`traffic_record` テーブルに保存し、後続リプレイに利用。

```java
if (recordEnabled && uriWhiteList.contains(requestURI)) {
    recordService.saveTraffic(request);
}
```

✅ **成果**：オンラインでの制御可能な録画を実現。録画精度99%、本番トラフィックに無侵入で挿入可能。

---

### 2️⃣ トラフィックリプレイモジュール

- テスト環境で ApplyReplayFilter を使用し、ログイン状態と権限を自動構築；
- ticket と session を注入し、実ユーザーアクセスをシミュレーション；
- OkHttp を利用して新旧システムインターフェースを並列リクエスト（灰度版 vs 旧版）；
- 再試行およびレート制限戦略を設計し、被テストサービスの過負荷を回避。

```java
OkHttpClient client = new OkHttpClient();
Request request = new Request.Builder()
    .url(targetUrl)
    .addHeader("ticket", mockTicket)
    .post(RequestBody.create(mediaType, requestBody))
    .build();
Response response = client.newCall(request).execute();
```

✅ **成果**：設定可能な並列リプレイフレームワークを実装。1万件以上の同時リクエストに対応し、平均処理時間を45%短縮。

---

### 3️⃣ 結果比較モジュール

- JSON Diff アルゴリズムに基づきレスポンス内容の整合性を比較；
- HikariCP により新旧データベース接続を確立；
- 各テーブルを行単位で比較し、設定により指定されたカラムを除外；
- 結果を XLS レポートとして出力し、差異項目と一致率を表示。

```yaml
tables:
  - name: BIZ_ORDER
    ignoredColumns:
      - CREATE_TIME
      - UPDATE_TIME
```

✅ **成果**：自動比較メカニズムを実現し、一致率86%。差異項目の手動確認効率を3倍向上。

---

### 4️⃣ レポートおよび自動化統合

- テストカバレッジ、一致率、異常比率を自動集計；
- XLSおよびHTML形式のレポートを生成；
- 「録画→リプレイ→比較→出力」全プロセスをワンクリック実行可能。

✅ **成果**：完全なツールチェーンを形成し、回帰フェーズで毎日自動実行可能。

---

### 5️⃣ ビジネスおよび品質成果

《トラフィックリプレイテスト報告_0420.pdf》の結果によると：

- カバーされたインターフェース：81%；
- リプレイリクエスト総数：116；
- レスポンス一致率：86%；
- データテーブル一致率：94%+；
- 回帰テストサイクルを約70%短縮；
- リリース前の潜在的なインターフェース互換性問題を多数防止。

---

## 五、課題と経験のまとめ

### 🚧 課題1：録画と本番環境の分離
録画時に低侵入性を維持し、業務トラフィックへの影響を避ける必要がある。  
👉 解決策：Filterをプラグイン方式で設計し、非同期書き込みを採用。

### ⚙️ 課題2：リプレイ権限の問題
リプレイリクエストがCAS認証を通過できない。  
👉 解決策：session + ticketをシミュレーションし、リプレイフィルタでログインをバイパス。

### 🧮 課題3：データベース比較の性能
大規模テーブルではデータ量が数十万行に達し、初期版の比較は時間がかかる。  
👉 解決策：ページング並列比較 + HikariCP接続プール再利用により、性能を4倍向上。

---

## 六、経験と学び

- **トラフィック録画 → リプレイ → 比較** の完全実装を習得；
- **HTTPリクエスト再構築、セッションシミュレーション、並列制御** を深く理解；
- **データベース整合性検証と自動化テストツール設計** に精通；
- 複雑なシステムにおける持続可能なテスト基盤設計能力を向上；
- 本ツールは EIR プラットフォームの複数回の回帰テストで使用され、QAチームの中核自動化基盤となった。
