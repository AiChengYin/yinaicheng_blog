# Nginx负载均衡

## Nginx简介

Nginx是一款轻量级的Web服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器，并在一个BSD协议下发行，
可以在UNIX、GNU/Linux、BSD、Mac OS X、Solaris以及Microsoft Windows等操作系统中运行。

Nginx由俄罗斯的程序设计师lgor Sysoev所开发，最初提供给俄罗斯大型的入口网站及搜索引擎Rambler使用，
用以解决C10k问题（C就是并发，10K就是一万），其特点是占用内存少，并发能力强，事实上Nginx的并发能力确实在同类型的网页服务器中表现较好。

相较于Apache具有占用内存少、稳定性高等优势，Nginx使用异步事件驱动的方法来处理请求，与旧版本的Apache不同，Nginx不采用每客户机一线程的设计模型，
而是充分使用异步逻辑从而削减了上下文调度开销，所以并发服务能力更强，整体采用模块化设计，有丰富的模块库和第三方模块库，配置灵活，
在Linux操作系统下，Nginx使用epoll事件模型，得益于此，Nginx在Linux操作系统下效率相当高。

Nginx作为一个强大的Web服务器软件，具有高性能、处理高并发和低内存占用的特点，Nginx在官方测试的结果中，能够支持五万个并行连接，
而在实际的运作中，可以支持二万至四万个并行连接，此外，其也能够提供强大的反向代理功能。据统计，Nginx被发现是所有"活跃"站点和百万最繁忙站点中使用次数最多的Web服务器。

## 正向代理

如果你无法访问一个网站，可以配置一个跳板机，进行外部访问，Opera浏览器就是进行正向代理，进行网络压缩和加速功能。

正向代理类似一个跳板机，代理访问外部资源，需要配置代理服务器地址。

正向代理是一个位于客户端和原始服务器之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并且指定目标（原始服务器），
然后代理向原始服务器转交请求并且将获得的内容返回给客户端，客户端必须要进行一些特别的设置才能使用正向代理。

![](./photo/nginx_forward_proxy.png)

## 反向代理

实际运行方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，
并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。

反向代理的作用：
* 保证内网的安全，可以使用反向代理提供WAF功能，阻止web攻击，大型网站，通常将反向代理作为公网访问地址，Web服务器是内网。

![](./photo/nginx_reverse_proxy_alpha.png)

* 负载均衡，通过反向服务器来优化网站的负载。

![](./photo/nginx_reverse_proxy_beta.png)

> 正向代理与反向代理的区别

客户端是无感知反向代理的存在的，访问者并不知道自己访问的是一个代理。

![](./photo/nginx_forward_reverse_proxy_difference.png)

基于反向代理的功能，Nginx作为负载均衡主要有以下几点理由：
* 高并发连接
* 内存消耗少
* 配置文件非常简单
* 成本低廉
* 支持Rewrite重写规则
* 内置的健康检查功能
* 节省带宽
* 稳定性高

## 使用负载均衡的理由

随着业务（订单、访问量...）拓展，系统并发量、系统流量不断扩大，可以通过垂直扩展方向和水平扩展方向这两种思路解决系统瓶颈问题

### 垂直扩展

即通过定位系统瓶颈，提升相应的硬件配置来解决系统瓶颈问题

提升单机硬件配置（CPU、内存、网卡、硬盘），就像搬砖任务太重，一个小孩搬不完，换一个大人来搬就行了

2核的cpu更新为8核的，内存如果太少可以加内存，机械硬盘读取速度慢可以换成SSD硬盘，如果确定是网络瓶颈可以将百兆千兆网卡换成万兆网卡

摩尔定律：当价格不变时，集成电路上可以容纳的元器件的数目，约每隔18-24个月便会增加一倍，性能也将提升一倍

缺点：摩尔定律已经放缓，单机扩展性能提高是有限的，而且成本会越来越高

### 水平扩展

理论上，在系统能支持水平扩展的前提下，增加服务器数量，部署更新机器集群，能够带来无限的性能提升，就像搬砖任务太重，一个小孩搬不完，再加几个小孩来搬就行了

目前在高并发高可用系统架构中，最优的方案还是水平扩展

使用网络负载均衡器可以将网络请求分布给多个机器去处理

负载均衡本质：追求理论无限水平扩展的过程

## 负载均衡原理

负载均衡，单从字面上的意思来理解就可以解释为N台服务器平均分担负载，不会出现因为某台服务器负载高而宕机和某台服务器闲置的情况，负载均衡的前提就是需要两台以上的服务器才能实现。

目前Nginx负载均衡有四种方案配置。

> 轮询

根据Nginx配置文件中的服务器顺序，依次把客户端的Web请求分发到不同的后端服务器上。

> 最少连接

Web请求会被转发到连接数最少的服务器上。

> IP地址哈希

前述的两种负载均衡方案中，同一客户端连续的Web请求可能会被分发到不同的后端服务器中进行处理。因此如果涉及到会话Session会比较复杂。
要克服上面的难题，可以使用基于IP地址哈希的负载均衡方案。这样的话，同一客户端连续的Web请求都会被分发到同一服务器进行处理。

> 基于权重weight

这种方式下，我们可以配置Nginx把请求更多地分发到高配置的后端服务器上，把相对较少的请求分发到低配服务器。

## 负载均衡配置

配置的域名是yinaicheng.top，监听80端口，当请求访问yinaicheng.top域名，会把请求负载到后面三台web服务上。

> 查找Nginx

因为备份、不同版本等问题，导致Linux服务器上可能存放有多个Nginx目录，可以通过如下方法定位当前正在运行的Nginx的配置文件。

* 查看Nginx的PID，以常用的80端口为例

输入
```log
netstat -anop | grep 0.0.0.0:80
```

输出
```log
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      981777/nginx: maste  off (0.00/0/0)
```

* 通过上面的命令得到的相应进程ID查询当前正在运行的Nginx所在路径，如果进程号为981777

输入
```log
ll /proc/981777/exe
```

输出
```log
lrwxrwxrwx 1 root root 0 Sep  8 11:24 /proc/981777/exe -> /www/server/nginx/sbin/nginx
```

* 获取到Nginx的执行路径后，使用-t参数即可获取该进程对应的配置文件路径

输入
```sbtshell
/www/server/nginx/sbin/nginx -t
```

输出
```log
nginx: [warn] the "ssl" directive is deprecated, use the "listen ... ssl" directive instead in /www/server/nginx/conf/nginx.conf:71
nginx: [warn] the "ssl" directive is deprecated, use the "listen ... ssl" directive instead in /www/server/nginx/conf/nginx.conf:98
nginx: [warn] conflicting server name "yinaicheng.top" on 0.0.0.0:443, ignored
nginx: [warn] conflicting server name "yinaicheng.top" on 0.0.0.0:80, ignored
nginx: the configuration file /www/server/nginx/conf/nginx.conf syntax is ok
nginx: configuration file /www/server/nginx/conf/nginx.conf test is successful
```

这里我们可以看到Nginx的配置文件所在位置为/www/server/nginx/conf，配置文件名称为nginx.conf，可以根据自己的需求更新该配置文件。

> 修改本机Host文件

可能要测试的域名并非真实的域名，为了测试方便，可以通过修改host文件，修改域名指向。

输入
```log
vim /etc/hosts
```

修改本机的host文件，退出vim编辑使用:wq命令
```log
127.0.0.1 yinaicheng.top
```

验证是否生效
```log
ping yinaicheng.top
```

验证生效结果
```log
PING yinaicheng.top (127.0.0.1) 56(84) bytes of data.
64 bytes from VM-0-8-centos (127.0.0.1): icmp_seq=1 ttl=64 time=0.061 ms
64 bytes from VM-0-8-centos (127.0.0.1): icmp_seq=2 ttl=64 time=0.051 ms
64 bytes from VM-0-8-centos (127.0.0.1): icmp_seq=3 ttl=64 time=0.043 ms
64 bytes from VM-0-8-centos (127.0.0.1): icmp_seq=4 ttl=64 time=0.051 ms
```

> 配置基于Round Robin轮询的负载均衡

```log
user www-data;
worker_processes auto;
pid /run/nginx.pid;

events{
	use epoll;
	worker_connections 65535;
}

http{

	upstream yinaicheng.top {
		server 127.0.0.1:8881;
		server 127.0.0.1:8882;
		server 127.0.0.1:8883;
	}

	server{
		listen 80;
		server_name yinaicheng.top;
		
		location / {
			proxy_pass http://yinaicheng.top;
			proxy_set_header Host		$host;
			proxy_set_header X-Real-IP		$remote_addr;
		}
	}
}
```

需要注意以下几点：
1. 缺省配置就是轮询策略。
2. Nginx负载均衡支持http和https协议，只需要修改proxy_pass后的协议即可。
3. Nginx支持FastCGI、uwsgi、SCGI、memcached的负载均衡，只需要讲proxy_pass改为fastcgi_pass、uwsgi_pass、scgi_pass、memcached_pass即可。
4. 此策略适合服务器配置相当，无状态而且短平快的服务使用。

> 配置基于ip_hash的负载均衡

```log
user www-data;
worker_processes auto;
pid /run/nginx.pid;

events{
	use epoll;
	worker_connections 65535;
}

http{

	upstream yinaicheng.top {
		ip_hash;
		server 127.0.0.1:8881;
		server 127.0.0.1:8882;
		server 127.0.0.1:8883;
	}

	server{
		listen 80;
		server_name yinaicheng.top;
		
		location / {
			proxy_pass http://yinaicheng.top;
			proxy_set_header Host		$host;
			proxy_set_header X-Real-IP		$remote_addr;
		}
	}
}
```

需要注意以下几点：
1. ip哈希负载均衡使用ip_hash指令定义。
2. Nginx使用请求客户端的ip地址进行哈希计算，确保使用同一个服务器响应请求。
3. 此策略适合有状态服务，比如session。

## 配置基于least_conn的负载均衡

```log
user www-data;
worker_processes auto;
pid /run/nginx.pid;

events{
	use epoll;
	worker_connections 65535;
}

http{

	upstream yinaicheng.top {
		least_conn;
		server 127.0.0.1:8881;
		server 127.0.0.1:8882;
		server 127.0.0.1:8883;
	}

	server{
		listen 80;
		server_name yinaicheng.top;
		
		location / {
			proxy_pass http://yinaicheng.top;
			proxy_set_header Host		$host;
			proxy_set_header X-Real-IP		$remote_addr;
		}
	}
}
```

需要注意以下几点：

1. 最少连接负载均衡通过least_conn指令定义。
2. 此负载均衡策略适合请求处理时间长短不一造成服务器过载的情况。

## 配置基于权重的负载均衡

```log
user www-data;
worker_processes auto;
pid /run/nginx.pid;

events{
	use epoll;
	worker_connections 65535;
}

http{

	upstream yinaicheng.top {
		least_conn;
		server 127.0.0.1:8881 weight=3;
		server 127.0.0.1:8882 weight=2;
		server 127.0.0.1:8883 weight=1;
	}

	server{
		listen 80;
		server_name yinaicheng.top;
		
		location / {
			proxy_pass http://yinaicheng.top;
			proxy_set_header Host		$host;
			proxy_set_header X-Real-IP		$remote_addr;
		}
	}
}
```

需要注意以下几点：
1. 权重负载均衡需要使用weight指令定义。
2. 权重越高分配到需要处理的请求越多。
3. 此策略可以与最少连接负载和ip哈希策略结合使用。
4. 此策略比较适合服务器的硬件配置差别比较大的情况。

